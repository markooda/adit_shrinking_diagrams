name: Sync Azure Board Task with PR Status

on:
  pull_request:
    types: [edited, closed]

jobs:
  update_task:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true ||
      contains(github.event.pull_request.title, 'TESTING') ||
      contains(github.event.pull_request.title, 'TEST FAILED')

    steps:
      - name: Extract task number
        id: extract
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Pull Request title: $PR_TITLE"

          if [[ "$PR_TITLE" =~ ([0-9]+) ]]; then
            echo "task_id=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Found task ID: ${BASH_REMATCH[1]}"
          else
            echo "No task ID found in PR title."
          fi

      - name: Determine new Azure DevOps state
        id: state
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          NEW_STATE=""

          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            NEW_STATE="Done"
          elif echo "$TITLE" | grep -qi "TESTING"; then
            NEW_STATE="Testing"
          elif echo "$TITLE" | grep -qi "TEST FAILED"; then
            NEW_STATE="Doing"
          fi

          if [ -n "$NEW_STATE" ]; then
            echo "new_state=$NEW_STATE" >> $GITHUB_OUTPUT
            echo "New state: $NEW_STATE"
          else
            echo "No matching state found; skipping update."
          fi

      - name: Move Azure Board work item
        if: steps.extract.outputs.task_id != '' && steps.state.outputs.new_state != ''
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
        run: |
          echo "Moving Azure DevOps task ID ${{ steps.extract.outputs.task_id }} to '${{ steps.state.outputs.new_state }}'..."
          AUTH_HEADER=$(echo -n ":${AZURE_DEVOPS_PAT}" | base64 | tr -d '\n')
          
          curl -X PATCH \
            -H "Content-Type: application/json-patch+json" \
            -H "Authorization: Basic ${AUTH_HEADER}" \
            -d '[{"op":"add","path":"/fields/System.State","value":"${{ steps.state.outputs.new_state }}"}]' \
            "https://dev.azure.com/teamok/Shrinking%20diagrams/_apis/wit/workitems/${{ steps.extract.outputs.task_id }}?api-version=7.0"
